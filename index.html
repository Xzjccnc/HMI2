<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœªæ¥è½¦è½½æ‰‹åŠ¿äº¤äº’ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- å¼•å…¥ MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- å¼•å…¥ FontAwesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* 3D èƒŒæ™¯å±‚ */
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* UI å±‚ */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; pointer-events: none; }
        
        /* å…è®¸äº¤äº’çš„å…ƒç´  */
        .interactive { pointer-events: auto; }

        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-panel {
            background: rgba(16, 20, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        /* å±å¹•åˆ‡æ¢åŠ¨ç”» */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none;
            padding: 80px 40px 40px 40px; /* Top padding for header */
            box-sizing: border-box;
        }

        .screen.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            z-index: 20;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            z-index: 50;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: rgba(255,255,255,0.7);
        }

        /* æ‰‹åŠ¿å…‰æ ‡ */
        #hand-cursor {
            position: fixed;
            width: 20px; height: 20px;
            border: 2px solid #00f3ff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 0 10px #00f3ff;
            transition: width 0.1s, height 0.1s;
        }
        #hand-cursor.pinching {
            background-color: #00f3ff;
            width: 10px; height: 10px;
        }

        /* ä»ªè¡¨ç›˜é€Ÿåº¦å­— */
        .speed-text {
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(64, 169, 255, 0.6);
        }

        /* åœ°å›¾ç½‘æ ¼æ¨¡æ‹Ÿ */
        .map-grid {
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            width: 200%; height: 200%;
            position: absolute; top: -50%; left: -50%;
            transform-origin: center;
            transition: transform 0.1s linear;
        }
        
        /* éšè—è§†é¢‘ */
        #input-video { display: none; }

        /* åŠ è½½é¡µ */
        #loader {
            position: fixed; inset: 0; z-index: 999;
            background: #000; color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .gesture-hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;
            font-size: 14px; color: #aaa; pointer-events: none;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- åŠ è½½ä¸å¯åŠ¨ -->
    <div id="loader">
        <h1 class="text-3xl font-bold mb-2 text-blue-400">VISION OS <span class="text-xs align-top">V1.0</span></h1>
        <p class="text-gray-400 mb-8">è½¦è½½æ‰‹åŠ¿æ§åˆ¶ç³»ç»Ÿå¯åŠ¨ä¸­...</p>
        <button id="start-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 rounded-full font-bold transition shadow-[0_0_20px_rgba(37,99,235,0.5)]">
            å¯åŠ¨å¼•æ“ (å¼€å¯æ‘„åƒå¤´)
        </button>
        <p id="error-msg" class="text-red-400 mt-4 text-sm hidden max-w-md text-center"></p>
    </div>

    <!-- æ‘„åƒå¤´æº -->
    <video id="input-video"></video>

    <!-- 3D èƒŒæ™¯ -->
    <div id="canvas-bg"></div>

    <!-- æ‰‹åŠ¿å…‰æ ‡ -->
    <div id="hand-cursor" class="hidden"></div>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar font-mono">
            <div class="flex items-center gap-4">
                <i class="fas fa-wifi text-blue-400"></i>
                <span>21:45</span>
                <span class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-300">USER: ADMIN</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-temperature-low"></i> 22Â°C
                </div>
                <div id="gesture-status" class="text-xs text-yellow-400 font-bold opacity-0 transition-opacity">
                    æ£€æµ‹åˆ°æŒ¥æ‰‹
                </div>
            </div>
        </div>

        <!-- å±å¹• 1: ä»ªè¡¨ç›˜ (Dashboard) -->
        <div id="screen-dashboard" class="screen active">
            <div class="flex h-full gap-6">
                <!-- å·¦ä¾§ï¼šä¸»è¦è½¦è¾†ä¿¡æ¯ -->
                <div class="w-1/2 flex flex-col justify-center items-center">
                    <div class="relative w-80 h-80 rounded-full border-4 border-gray-800 flex items-center justify-center glass-panel shadow-[0_0_50px_rgba(0,100,255,0.1)]">
                        <div class="absolute inset-0 rounded-full border-t-4 border-blue-500 animate-spin" style="animation-duration: 3s;"></div>
                        <div class="text-center">
                            <div class="text-7xl font-bold text-white speed-text" id="speed-display">0</div>
                            <div class="text-blue-400 text-xl font-bold mt-2">KM/H</div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-8">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400">85%</div>
                            <div class="text-xs text-gray-400">ç”µé‡</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-white">320</div>
                            <div class="text-xs text-gray-400">ç»­èˆª (KM)</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-white">D</div>
                            <div class="text-xs text-gray-400">æ¡£ä½</div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå°ç»„ä»¶ -->
                <div class="w-1/2 flex flex-col gap-6 justify-center">
                    <!-- è¿·ä½ åœ°å›¾ -->
                    <div class="glass-panel p-4 h-48 relative overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-300"><i class="fas fa-map-marker-alt text-red-400 mr-2"></i> å¯¼èˆªä¸­</span>
                            <span class="text-xs text-blue-400">å‰©ä½™ 12 KM</span>
                        </div>
                        <div class="flex-1 bg-gray-900 rounded-lg relative overflow-hidden opacity-80">
                            <!-- ç®€å•çš„é™æ€æ¨¡æ‹Ÿåœ°å›¾çº¿ -->
                            <div class="absolute top-1/2 left-0 w-full h-1 bg-blue-600 shadow-[0_0_10px_#2563eb]"></div>
                            <div class="absolute top-1/2 left-1/2 w-4 h-4 bg-white rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-lg z-10"></div>
                        </div>
                    </div>

                    <!-- è¿·ä½ éŸ³ä¹ -->
                    <div class="glass-panel p-4 h-32 flex items-center gap-4">
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-music text-2xl text-white"></i>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-white">Cyberdrive</div>
                            <div class="text-sm text-gray-400">Neon City Soundtrack</div>
                            <div class="flex gap-3 mt-3 text-gray-300 text-sm">
                                <i class="fas fa-backward hover:text-white"></i>
                                <i class="fas fa-pause hover:text-white"></i>
                                <i class="fas fa-forward hover:text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="gesture-hint">ğŸ‘‹ å·¦å³æŒ¥æ‰‹åˆ‡æ¢ç•Œé¢</div>
        </div>

        <!-- å±å¹• 2: åœ°å›¾ (Map) -->
        <div id="screen-map" class="screen">
            <div class="w-full h-full glass-panel relative overflow-hidden flex flex-col">
                <!-- æ¨¡æ‹Ÿåœ°å›¾å†…å®¹ -->
                <div class="absolute inset-0 bg-gray-900 overflow-hidden">
                    <div id="map-grid-layer" class="map-grid"></div>
                    <!-- è·¯çº¿ -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 5;">
                        <path d="M 0 500 Q 400 400 600 300 T 1200 100" stroke="#00f3ff" stroke-width="4" fill="none" filter="url(#glow)"/>
                        <defs>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                    </svg>
                    <!-- è½¦è¾†ä½ç½® -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10">
                        <div class="w-0 h-0 border-l-[10px] border-l-transparent border-b-[20px] border-b-blue-500 border-r-[10px] border-r-transparent drop-shadow-[0_0_10px_rgba(59,130,246,1)]"></div>
                    </div>
                </div>
                
                <!-- åœ°å›¾ UI -->
                <div class="absolute top-4 left-4 p-4">
                    <h2 class="text-2xl font-bold text-white">å¯¼èˆªåœ°å›¾</h2>
                    <p class="text-blue-300">ç›®æ ‡: ç§‘æŠ€å›­åŒº A åº§</p>
                </div>

                <div class="absolute bottom-8 right-8 glass-panel px-4 py-2">
                    <span class="text-gray-300 text-sm mr-2">ç¼©æ”¾çº§åˆ«</span>
                    <span id="map-zoom-display" class="font-bold text-white">100%</span>
                </div>
                
                <div class="absolute inset-x-0 bottom-20 flex justify-center pointer-events-none">
                    <div class="bg-black/60 px-4 py-2 rounded-full text-sm text-blue-200 backdrop-blur">
                        ğŸ‘Œ æåˆæ‰‹åŠ¿ç¼©æ”¾åœ°å›¾
                    </div>
                </div>
            </div>
            <div class="gesture-hint">ğŸ‘‹ å·¦å³æŒ¥æ‰‹åˆ‡æ¢ç•Œé¢</div>
        </div>

        <!-- å±å¹• 3: éŸ³ä¹ (Music) -->
        <div id="screen-music" class="screen">
            <div class="w-full h-full flex flex-col items-center justify-center relative">
                
                <!-- å”±ç‰‡æœºæ•ˆæœ -->
                <div class="relative w-64 h-64 mb-8">
                     <!-- ç®€å•çš„éŸ³é¢‘å¯è§†åŒ–æ³¢çº¹ -->
                    <div class="absolute inset-0 rounded-full border-2 border-purple-500 opacity-50 animate-ping" style="animation-duration: 2s;"></div>
                    <div class="absolute inset-0 rounded-full border-2 border-blue-500 opacity-50 animate-ping" style="animation-delay: 0.5s; animation-duration: 2s;"></div>
                    
                    <div class="w-full h-full rounded-full bg-gradient-to-br from-gray-800 to-black border-4 border-gray-700 shadow-[0_0_50px_rgba(147,51,234,0.4)] flex items-center justify-center overflow-hidden">
                        <img src="https://picsum.photos/seed/cyber/300/300" class="w-full h-full object-cover opacity-80" alt="Album Art">
                    </div>
                </div>

                <h2 class="text-4xl font-bold text-white mb-2">Midnight Drive</h2>
                <p class="text-xl text-purple-400 mb-12">Synthwave Collective</p>

                <!-- éŸ³é‡æ§åˆ¶æ¡ -->
                <div class="w-2/3 max-w-lg">
                    <div class="flex justify-between text-gray-400 text-sm mb-2">
                        <i class="fas fa-volume-down"></i>
                        <span id="volume-text">VOL 50%</span>
                        <i class="fas fa-volume-up"></i>
                    </div>
                    <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="volume-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-1/2 transition-all duration-100 ease-out"></div>
                    </div>
                </div>

                <div class="mt-12 flex gap-12 text-3xl text-gray-300">
                    <i class="fas fa-step-backward hover:text-white cursor-pointer transition"></i>
                    <i class="fas fa-pause-circle text-5xl text-white hover:scale-110 cursor-pointer transition shadow-glow"></i>
                    <i class="fas fa-step-forward hover:text-white cursor-pointer transition"></i>
                </div>

                <div class="absolute bottom-20 text-sm text-purple-200 bg-black/40 px-4 py-2 rounded-full">
                    ğŸ‘Œ æåˆæ‰‹åŠ¿è°ƒèŠ‚éŸ³é‡
                </div>
            </div>
            <div class="gesture-hint">ğŸ‘‹ å·¦å³æŒ¥æ‰‹åˆ‡æ¢ç•Œé¢</div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶æ  -->
        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-2">
            <div class="w-3 h-3 rounded-full bg-white opacity-100 nav-dot" id="dot-0"></div>
            <div class="w-3 h-3 rounded-full bg-white opacity-30 nav-dot" id="dot-1"></div>
            <div class="w-3 h-3 rounded-full bg-white opacity-30 nav-dot" id="dot-2"></div>
        </div>
        
        <button onclick="toggleFullScreen()" class="absolute bottom-6 right-6 text-gray-400 hover:text-white text-xl interactive">
            <i class="fas fa-expand"></i>
        </button>
    </div>

    <script>
        // --- ç³»ç»ŸçŠ¶æ€ ---
        const State = {
            screens: ['dashboard', 'map', 'music'],
            currentIndex: 0,
            volume: 50,
            mapZoom: 1.0,
            speed: 0,
            lastGestureTime: 0,
            handDetected: false
        };

        // --- 1. Three.js èƒŒæ™¯åŠ¨ç”» (æ— é™éš§é“) ---
        let scene, camera, renderer;
        function initThreeJS() {
            // Prevent multiple inits
            if (scene) return;
            
            const container = document.getElementById('canvas-bg');
            scene = new THREE.Scene();
            // ç®€å•çš„èµ›åšæœ‹å…‹é›¾æ•ˆ
            scene.fog = new THREE.FogExp2(0x000000, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            camera.position.y = 1;

            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // åˆ›å»ºç½‘æ ¼åœ°é¢
            const gridHelper = new THREE.GridHelper(200, 100, 0x00f3ff, 0x222222);
            gridHelper.position.y = -2;
            scene.add(gridHelper);

            // åˆ›å»ºéš§é“å¢™å£ (ç²’å­)
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 3000; i++) {
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 60;
                const z = (Math.random() - 0.5) * 200; // Deep depth
                vertices.push(x, y, z);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x40a9ff, size: 0.15 });
            const stars = new THREE.Points(geometry, material);
            scene.add(stars);

            // åŠ¨ç”»å¾ªç¯
            const animate = function () {
                requestAnimationFrame(animate);

                // æ ¹æ®è½¦é€Ÿç§»åŠ¨åœ°é¢å’Œæ˜Ÿæ˜Ÿ
                // åŸºç¡€é€Ÿåº¦ + æ¨¡æ‹Ÿè½¦é€Ÿ
                const moveSpeed = 0.2 + (State.speed * 0.01);
                
                gridHelper.position.z += moveSpeed;
                if(gridHelper.position.z > 2) gridHelper.position.z = 0;

                stars.position.z += moveSpeed;
                if(stars.position.z > 100) stars.position.z = -100;

                // æ¨¡æ‹Ÿè½¦è¾†æ™ƒåŠ¨
                camera.position.x = Math.sin(Date.now() * 0.001) * 0.05;

                renderer.render(scene, camera);
            };

            animate();

            // çª—å£è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- 2. UI é€»è¾‘ ---
        function switchScreen(direction) {
            const now = Date.now();
            if (now - State.lastGestureTime < 1000) return; // å†·å´æ—¶é—´ 1ç§’
            State.lastGestureTime = now;

            const oldIndex = State.currentIndex;
            if (direction === 'next') {
                State.currentIndex = (State.currentIndex + 1) % State.screens.length;
            } else {
                State.currentIndex = (State.currentIndex - 1 + State.screens.length) % State.screens.length;
            }

            // æ›´æ–° DOM
            document.querySelectorAll('.screen').forEach((el, idx) => {
                if(idx === State.currentIndex) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            // æ›´æ–°åº•éƒ¨åœ†ç‚¹
            document.querySelectorAll('.nav-dot').forEach((el, idx) => {
                el.style.opacity = idx === State.currentIndex ? '1' : '0.3';
            });

            // æ‰‹åŠ¿æç¤º UI
            const status = document.getElementById('gesture-status');
            status.innerText = direction === 'next' ? "å‘å·¦æŒ¥åŠ¨" : "å‘å³æŒ¥åŠ¨";
            status.style.opacity = 1;
            setTimeout(() => status.style.opacity = 0, 1500);
        }

        function updateSpeedometer() {
            // æ¨¡æ‹Ÿè½¦é€Ÿå˜åŒ–
            if(State.speed < 80) State.speed += Math.random() * 2;
            else if(State.speed > 85) State.speed -= Math.random() * 2;
            
            // ç®€å•å¹³æ»‘
            document.getElementById('speed-display').innerText = Math.floor(State.speed);
        }

        function updateVolume(factor) {
            // factor 0 to 1
            State.volume = Math.min(100, Math.max(0, factor * 100));
            document.getElementById('volume-bar').style.width = State.volume + '%';
            document.getElementById('volume-text').innerText = `VOL ${Math.floor(State.volume)}%`;
        }

        function updateMapZoom(factor) {
            // factor 0 to 1 approx, map to 0.5 to 3.0
            const zoom = 0.5 + (factor * 3);
            State.mapZoom = State.mapZoom + (zoom - State.mapZoom) * 0.1; // Lerp
            
            const grid = document.getElementById('map-grid-layer');
            grid.style.transform = `scale(${State.mapZoom})`;
            document.getElementById('map-zoom-display').innerText = Math.floor(State.mapZoom * 100) + "%";
        }

        setInterval(updateSpeedometer, 100);

        // --- 3. æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ (MediaPipe) ---
        const videoElement = document.getElementById('input-video');
        const cursor = document.getElementById('hand-cursor');
        
        let lastHandX = null;
        const SWIPE_THRESHOLD = 0.05; // ç§»åŠ¨è·ç¦»é˜ˆå€¼ (normalized coords)

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                State.handDetected = true;
                cursor.classList.remove('hidden');

                // 1. è·å–é£ŸæŒ‡(8)å’Œæ‰‹è…•(0) ç”¨äºå…‰æ ‡å®šä½ (Mirror X)
                const indexTip = landmarks[8];
                const x = (1 - indexTip.x) * window.innerWidth;
                const y = indexTip.y * window.innerHeight;
                
                cursor.style.left = x + 'px';
                cursor.style.top = y + 'px';

                // 2. æŒ¥æ‰‹æ£€æµ‹ (Swipe) - ä½¿ç”¨æ‰‹è…•æˆ–æŒå¿ƒçš„ X è½´ç§»åŠ¨
                // å¹³æ»‘å¤„ç†: ç®€å•çš„ delta æ£€æŸ¥
                const currentHandX = landmarks[0].x; // Wrist X
                
                if (lastHandX !== null) {
                    const deltaX = currentHandX - lastHandX;
                    
                    if (Math.abs(deltaX) > 0.08) { // å¿«é€Ÿç§»åŠ¨
                        if (deltaX < 0) {
                            switchScreen('next'); // å‘å·¦æŒ¥
                        } else {
                            switchScreen('prev'); // å‘å³æŒ¥
                        }
                        lastHandX = null; // é‡ç½®é˜²æ­¢è¿ç»­è§¦å‘
                    }
                }
                lastHandX = currentHandX;


                // 3. æåˆæ£€æµ‹ (Pinch) - æ‹‡æŒ‡(4) å’Œ é£ŸæŒ‡(8)
                const thumbTip = landmarks[4];
                const dist = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) + 
                    Math.pow(thumbTip.y - indexTip.y, 2)
                );

                // å¯è§†åŒ–æåˆ
                if(dist < 0.05) {
                    cursor.classList.add('pinching');
                } else {
                    cursor.classList.remove('pinching');
                }

                // æ ¹æ®å½“å‰ç•Œé¢åº”ç”¨å¼ åˆé€»è¾‘
                // å°†è·ç¦»æ˜ å°„åˆ°æœ‰ç”¨çš„èŒƒå›´ (0.02 ~ 0.25) -> (0 ~ 1)
                const normalizedValue = Math.min(1, Math.max(0, (dist - 0.02) * 5));

                if(State.screens[State.currentIndex] === 'music') {
                    updateVolume(normalizedValue);
                } else if(State.screens[State.currentIndex] === 'map') {
                    updateMapZoom(normalizedValue);
                }

            } else {
                State.handDetected = false;
                cursor.classList.add('hidden');
                lastHandX = null;
            }
        }

        // --- 4. åˆå§‹åŒ– ---
        const startBtn = document.getElementById('start-btn');
        const loader = document.getElementById('loader');
        const errorMsg = document.getElementById('error-msg');

        startBtn.addEventListener('click', async () => {
            startBtn.innerText = "æ­£åœ¨åˆå§‹åŒ–ä¼ æ„Ÿå™¨...";
            startBtn.disabled = true;
            errorMsg.classList.add('hidden');
            
            // åˆå§‹åŒ– Three.js (å¦‚æœå°šæœªåˆå§‹åŒ–)
            initThreeJS();

            // åˆå§‹åŒ– MediaPipe
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });

            try {
                await camera.start();
                loader.style.opacity = 0;
                setTimeout(() => loader.remove(), 500);
            } catch(e) {
                console.error("Camera error:", e);
                let message = "æ— æ³•å¯åŠ¨æ‘„åƒå¤´ã€‚";
                
                if (e.name === 'NotReadableError' || e.message.includes('Device in use')) {
                    message = "æ‘„åƒå¤´ä¼¼ä¹è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„è½¯ä»¶ï¼ˆå¦‚Zoom, Teamsç­‰ï¼‰æˆ–æµè§ˆå™¨æ ‡ç­¾é¡µï¼Œç„¶åé‡è¯•ã€‚";
                } else if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    message = "è¯·å…è®¸ç½‘é¡µè®¿é—®æ‘„åƒå¤´æƒé™ä»¥ç»§ç»­ã€‚";
                } else {
                    message += " é”™è¯¯: " + (e.message || e.name);
                }

                errorMsg.innerText = message;
                errorMsg.classList.remove('hidden');
                
                startBtn.innerText = "é‡è¯•å¯åŠ¨";
                startBtn.disabled = false;
            }
        });

        window.toggleFullScreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

    </script>
</body>
</html>