<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è½¦è½½äº¤äº’ç³»ç»Ÿ V3.0</title>
    
    <!-- å¤–éƒ¨èµ„æºå¼•å…¥ä¿æŒä¸å˜ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* 3D èƒŒæ™¯ */
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* UI å±‚ */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; pointer-events: none; }
        
        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 80px; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; align-items: center;
            padding-top: 40px; pointer-events: auto; z-index: 60;
        }
        .nav-item {
            width: 50px; height: 50px; margin-bottom: 30px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #666; cursor: pointer; transition: all 0.3s ease;
        }
        .nav-item:hover, .nav-item.active {
            color: #00f3ff; background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }
        .nav-item.bottom { margin-top: auto; margin-bottom: 40px; }

        /* ä¸»å†…å®¹ */
        #main-content { flex: 1; position: relative; height: 100%; }
        .interactive { pointer-events: auto; }
        .glass-panel {
            background: rgba(16, 20, 30, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); border-radius: 20px;
        }

        /* å±å¹•åˆ‡æ¢ */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none; padding: 80px 40px 40px 40px; box-sizing: border-box;
        }
        .screen.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; z-index: 20; }

        /* é¡¶éƒ¨æ  */
        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 50;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: rgba(255,255,255,0.7);
        }

        /* å…‰æ ‡ */
        #hand-cursor {
            position: fixed; width: 20px; height: 20px;
            border: 2px solid #00f3ff; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 100;
            pointer-events: none; box-shadow: 0 0 10px #00f3ff;
            transition: width 0.1s, height 0.1s, background-color 0.1s;
        }
        #hand-cursor.pinching { background-color: #00f3ff; width: 10px; height: 10px; }
        #hand-cursor.fist { background-color: #ff4d4f; border-color: #ff4d4f; box-shadow: 0 0 15px #ff4d4f; }

        /* åœ°å›¾å®¹å™¨ */
        #real-map-container { width: 100%; height: 100%; border-radius: 16px; z-index: 1; }
        /* è¦†ç›– Leaflet é»˜è®¤æ ·å¼ä»¥é€‚åº”æš—é»‘ä¸»é¢˜ */
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-container { background: #000 !important; }

        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .cover-art { transition: transform 0.5s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .cover-art.playing { animation: spin 10s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .control-btn { transition: all 0.2s; cursor: pointer; }
        .control-btn:hover { transform: scale(1.1); color: #fff; }
        .control-btn:active { transform: scale(0.95); }

        /* éšè—å…ƒç´  */
        #input-video { display: none; }
        
        /* é¢„è§ˆçª—å£ */
        #gesture-preview-container {
            position: fixed; bottom: 20px; left: 100px;
            width: 120px; height: 90px; z-index: 900;
            border-radius: 12px; overflow: hidden; background: #000;
            border: 2px solid rgba(0, 243, 255, 0.3);
        }
        #gesture-preview-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* åŠ è½½å±‚ */
        #loader { position: fixed; inset: 0; z-index: 999; background: #000; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* æ–°å¢ï¼šæ‰‹åŠ¿çŠ¶æ€æŒ‡ç¤ºå™¨ */
        #gesture-indicator {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.5);
            color: #00f3ff; padding: 4px 12px; border-radius: 20px;
            font-size: 12px; z-index: 800;
        }

        /* ç©ºè°ƒæ§åˆ¶ç•Œé¢æ ·å¼ */
        #screen-ac {
            align-items: center;
            justify-content: center;
        }
        
        .ac-container {
            width: 90%;
            max-width: 800px;
            height: 80%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        
        .ac-power {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ac-power.on {
            background: rgba(0, 243, 255, 0.2);
            border: 2px solid #00f3ff;
            color: #00f3ff;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.5);
        }
        
        .ac-power.off {
            background: rgba(100, 100, 100, 0.2);
            border: 2px solid #666;
            color: #666;
        }
        
        .ac-display {
            font-size: 64px;
            font-weight: bold;
            margin: 30px 0;
            color: white;
        }
        
        .ac-display.cool {
            color: #4fc3f7;
            text-shadow: 0 0 15px rgba(79, 195, 247, 0.7);
        }
        
        .ac-display.heat {
            color: #ff7043;
            text-shadow: 0 0 15px rgba(255, 112, 67, 0.7);
        }
        
        .ac-fan-direction {
            display: flex;
            gap: 40px;
            margin: 40px 0;
        }
        
        .fan-direction-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(30, 30, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
        }
        
        .fan-direction-btn.active {
            background: rgba(0, 243, 255, 0.2);
            border: 1px solid #00f3ff;
            color: #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        
        .ac-mode {
            display: flex;
            gap: 30px;
        }
        
        .mode-btn {
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn.cool {
            background: rgba(79, 195, 247, 0.2);
            border: 1px solid #4fc3f7;
            color: #4fc3f7;
        }
        
        .mode-btn.heat {
            background: rgba(255, 112, 67, 0.2);
            border: 1px solid #ff7043;
            color: #ff7043;
        }
        
        .mode-btn.active {
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        
        .mode-btn.heat.active {
            box-shadow: 0 0 20px rgba(255, 112, 67, 0.5);
        }
        
        .ac-gesture-hint {
            position: absolute;
            bottom: 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
            max-width: 80%;
            line-height: 1.6;
        }
    </style>
</head>
<body>

    <!-- éŸ³ä¹æ’­æ”¾å™¨æ ¸å¿ƒ -->
    <audio id="music-player" preload="auto"></audio>

    <!-- åŠ è½½ä¸å¯åŠ¨ -->
    <div id="loader">
        <h1 class="text-3xl font-bold mb-2 text-blue-400">VISION OS <span class="text-xs align-top">V3.0</span></h1>
        <p class="text-gray-400 mb-8">æ­£åœ¨åˆå§‹åŒ–åœ°å›¾å¼•æ“ä¸éŸ³é¢‘ç³»ç»Ÿ...</p>
        <button id="start-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 rounded-full font-bold transition shadow-[0_0_20px_rgba(37,99,235,0.5)]">
            å¯åŠ¨ç³»ç»Ÿ (å¼€å¯æ‘„åƒå¤´)
        </button>
        <p id="error-msg" class="text-red-400 mt-4 text-sm hidden max-w-md text-center"></p>
    </div>

    <!-- æ–°å¢ï¼šæ‰‹åŠ¿çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="gesture-indicator" class="hidden">æ­£åœ¨è¯†åˆ«æ‰‹åŠ¿...</div>

    <!-- è§†é¢‘æº -->
    <video id="input-video"></video>
    <div id="canvas-bg"></div>
    <div id="hand-cursor" class="hidden"></div>

    <div id="ui-layer">
        <!-- ä¾§è¾¹æ  -->
        <div id="sidebar">
            <div class="nav-item active" onclick="jumpToScreen(0)" id="nav-0" title="è½¦è¾†ä¿¡æ¯"><i class="fas fa-car"></i></div>
            <div class="nav-item" onclick="jumpToScreen(1)" id="nav-1" title="åœ°å›¾å¯¼èˆª"><i class="fas fa-location-arrow"></i></div>
            <div class="nav-item" onclick="jumpToScreen(2)" id="nav-2" title="å¤šåª’ä½“"><i class="fas fa-music"></i></div>
            <div class="nav-item" onclick="jumpToScreen(3)" id="nav-3" title="ç©ºè°ƒæ§åˆ¶"><i class="fas fa-wind"></i></div>
            <div class="nav-item bottom" onclick="toggleFullScreen()" title="å…¨å±"><i class="fas fa-expand"></i></div>
            <div class="nav-item" title="è®¾ç½®"><i class="fas fa-cog"></i></div>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div id="main-content">
            <div class="status-bar font-mono">
                <div class="flex items-center gap-4">
                    <i class="fas fa-wifi text-blue-400"></i>
                    <span id="clock">12:00</span>
                    <span class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-300">USER: DRIVER</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2"><i class="fas fa-temperature-low"></i> 24Â°C</div>
                    <div id="gesture-status" class="text-xs text-yellow-400 font-bold opacity-0 transition-opacity">æ‰‹åŠ¿è¯†åˆ«ä¸­</div>
                </div>
            </div>

            <!-- Screen 1: Dashboard -->
            <div id="screen-dashboard" class="screen active">
                <div class="flex h-full gap-6">
                    <div class="w-1/2 flex flex-col justify-center items-center">
                        <div class="relative w-80 h-80 rounded-full border-4 border-gray-800 flex items-center justify-center glass-panel shadow-[0_0_50px_rgba(0,100,255,0.1)]">
                            <div class="absolute inset-0 rounded-full border-t-4 border-blue-500 animate-spin" style="animation-duration: 3s;"></div>
                            <div class="text-center">
                                <div class="text-7xl font-bold text-white speed-text" id="speed-display">0</div>
                                <div class="text-blue-400 text-xl font-bold mt-2">KM/H</div>
                            </div>
                        </div>
                        <div class="mt-8 flex gap-8 text-center text-white">
                            <div><div class="text-2xl font-bold text-green-400">82%</div><div class="text-xs text-gray-400">ç”µé‡</div></div>
                            <div><div class="text-2xl font-bold">310</div><div class="text-xs text-gray-400">ç»­èˆª (KM)</div></div>
                            <div><div class="text-2xl font-bold">P</div><div class="text-xs text-gray-400">æ¡£ä½</div></div>
                        </div>
                    </div>
                    <div class="w-1/2 flex flex-col gap-6 justify-center">
                        <div class="glass-panel p-6 h-40 flex items-center gap-6 interactive cursor-pointer" onclick="jumpToScreen(1)">
                            <div class="w-16 h-16 bg-blue-900 rounded-full flex items-center justify-center text-2xl text-blue-300"><i class="fas fa-map-marked-alt"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-white">å¼€å§‹å¯¼èˆª</h3>
                                <p class="text-sm text-gray-400">ç‚¹å‡»è¿›å…¥å…¨å±åœ°å›¾</p>
                            </div>
                        </div>
                        <div class="glass-panel p-6 h-40 flex items-center gap-6 interactive cursor-pointer" onclick="jumpToScreen(2)">
                            <div class="w-16 h-16 bg-purple-900 rounded-full flex items-center justify-center text-2xl text-purple-300"><i class="fas fa-play"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="dash-song-title">æœªæ’­æ”¾</h3>
                                <p class="text-sm text-gray-400">ç‚¹å‡»è¿›å…¥éŸ³ä¹æ’­æ”¾å™¨</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen 2: Map (Real Leaflet Map) -->
            <div id="screen-map" class="screen">
                <div class="w-full h-full glass-panel relative overflow-hidden flex flex-col p-0">
                    <div id="real-map-container" class="interactive"></div>
                    
                    <!-- åœ°å›¾æœç´¢æµ®å±‚ -->
                    <div class="absolute top-4 left-4 right-4 z-[999] pointer-events-none">
                        <div class="flex justify-between items-start">
                            <div class="bg-black/80 backdrop-blur p-4 rounded-xl border border-white/10 pointer-events-auto flex gap-2">
                                <input type="text" id="map-search-input" placeholder="æœç´¢åœ°ç‚¹ (å¦‚: åŒ—äº¬å¸‚)" class="bg-transparent border-b border-gray-600 text-white focus:outline-none px-2 py-1 w-48">
                                <button onclick="searchLocation()" class="text-blue-400 hover:text-white"><i class="fas fa-search"></i></button>
                            </div>
                            <div class="bg-black/80 backdrop-blur p-2 rounded-lg border border-white/10 text-xs text-white">
                                ğŸ¤ æåˆç¼©æ”¾ | ğŸ–±ï¸ æ‹–æ‹½å¹³ç§»
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen 3: Music (Functional Player) -->
            <div id="screen-music" class="screen">
                <div class="w-full h-full flex flex-col items-center justify-center relative">
                    <div class="relative w-72 h-72 mb-8">
                        <div class="absolute inset-0 rounded-full border-4 border-gray-800 shadow-[0_0_50px_rgba(147,51,234,0.3)]"></div>
                        <img id="album-art" src="https://picsum.photos/seed/music/300/300" class="w-full h-full rounded-full object-cover cover-art">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-black rounded-full border-2 border-gray-700"></div>
                    </div>

                    <h2 class="text-4xl font-bold text-white mb-2 text-center truncate w-2/3" id="player-title">Select a Song</h2>
                    <p class="text-xl text-purple-400 mb-8" id="player-artist">Artist</p>

                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-2/3 max-w-lg mb-8">
                        <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-0 transition-all duration-300"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span id="curr-time">0:00</span>
                            <span id="total-time">0:00</span>
                        </div>
                    </div>

                    <!-- æ§ä»¶ -->
                    <div class="flex items-center gap-12 text-gray-300">
                        <i class="fas fa-step-backward text-3xl control-btn hover:text-white interactive" onclick="Music.prev()"></i>
                        <div class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center text-3xl cursor-pointer hover:scale-105 transition interactive" onclick="Music.toggle()">
                            <i class="fas fa-play ml-1" id="play-icon"></i>
                        </div>
                        <i class="fas fa-step-forward text-3xl control-btn hover:text-white interactive" onclick="Music.next()"></i>
                    </div>

                    <!-- éŸ³é‡ -->
                    <div class="mt-8 flex items-center gap-4 text-gray-400 text-sm">
                        <i class="fas fa-volume-down"></i>
                        <div class="w-32 h-1 bg-gray-700 rounded-full overflow-hidden">
                            <div id="volume-bar" class="h-full bg-white w-1/2"></div>
                        </div>
                        <i class="fas fa-volume-up"></i>
                    </div>

                    <div class="absolute bottom-10 text-xs text-gray-500 bg-black/40 px-4 py-2 rounded-full border border-white/5">
                        ğŸ‘‹ å·¦å³æŒ¥æ‰‹åˆ‡æ­Œ | âœŠ æ¡æ‹³æš‚åœ | ğŸ–ï¸ å¼ å¼€æ’­æ”¾
                    </div>
                </div>
            </div>

            <!-- Screen 4: Air Conditioner Control -->
            <div id="screen-ac" class="screen">
                <div class="ac-container glass-panel p-8 interactive">
                    <h2 class="text-2xl font-bold text-white mb-6">ç©ºè°ƒæ§åˆ¶ç³»ç»Ÿ</h2>
                    
                    <div class="ac-power off" id="ac-power-btn" onclick="toggleAC()">
                        <i class="fas fa-power-off"></i>
                    </div>
                    
                    <div class="ac-display" id="ac-temp-display">24Â°</div>
                    
                    <div class="ac-fan-direction">
                        <div class="fan-direction-btn" id="fan-down-btn" onclick="setFanDirection('down')">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="fan-direction-btn active" id="fan-middle-btn" onclick="setFanDirection('middle')">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="fan-direction-btn" id="fan-up-btn" onclick="setFanDirection('up')">
                            <i class="fas fa-chevron-up"></i>
                        </div>
                    </div>
                    
                    <div class="ac-mode">
                        <div class="mode-btn cool active" id="mode-cool-btn" onclick="setACMode('cool')">
                            <i class="fas fa-snowflake"></i> åˆ¶å†·
                        </div>
                        <div class="mode-btn heat" id="mode-heat-btn" onclick="setACMode('heat')">
                            <i class="fas fa-fire"></i> åˆ¶çƒ­
                        </div>
                    </div>
                </div>
                
                <div class="ac-gesture-hint">
                    <p>æ‰‹åŠ¿æ§åˆ¶æŒ‡å—: ğŸ‘ äº”æŒ‡å¼ å¼€(å¼€) | âœŠ æ¡æ‹³(å…³) | ğŸ“ˆ æ‰‹æŒä¸ŠæŒ¥(ä¸Šå¹é£) | ğŸ“‰ æ‰‹æŒä¸‹æŒ¥(ä¸‹å¹é£) | ğŸ‘‰ ä¸‰æŒ‡å³åˆ’(æš–é£) | ğŸ‘‰ ä¸¤æŒ‡å³åˆ’(å†·é£)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦ä¸‹è§’é¢„è§ˆ -->
    <div id="gesture-preview-container" class="interactive">
        <video id="gesture-preview-video" playsinline muted></video>
    </div>

    <script>
        // --- ç©ºè°ƒæ§åˆ¶æ¨¡å— ---
        const AC = {
            isOn: false,
            temperature: 24,
            mode: 'cool', // cool or heat
            fanDirection: 'middle', // up, middle, down
            
            togglePower() {
                this.isOn = !this.isOn;
                this.updateUI();
                return this.isOn;
            },
            
            setMode(mode) {
                if (!this.isOn) return;
                this.mode = mode;
                this.updateUI();
            },
            
            setFanDirection(direction) {
                if (!this.isOn) return;
                this.fanDirection = direction;
                this.updateUI();
            },
            
            increaseTemp() {
                if (!this.isOn) return;
                this.temperature = Math.min(this.temperature + 1, 30);
                this.updateUI();
            },
            
            decreaseTemp() {
                if (!this.isOn) return;
                this.temperature = Math.max(this.temperature - 1, 16);
                this.updateUI();
            },
            
            updateUI() {
                const powerBtn = document.getElementById('ac-power-btn');
                const tempDisplay = document.getElementById('ac-temp-display');
                
                // æ›´æ–°ç”µæºçŠ¶æ€
                if (this.isOn) {
                    powerBtn.classList.remove('off');
                    powerBtn.classList.add('on');
                    tempDisplay.style.opacity = 1;
                } else {
                    powerBtn.classList.remove('on');
                    powerBtn.classList.add('off');
                    tempDisplay.style.opacity = 0.5;
                }
                
                // æ›´æ–°æ¸©åº¦æ˜¾ç¤ºå’Œæ¨¡å¼
                tempDisplay.innerText = `${this.temperature}Â°`;
                if (this.mode === 'cool') {
                    tempDisplay.classList.remove('heat');
                    tempDisplay.classList.add('cool');
                    document.getElementById('mode-cool-btn').classList.add('active');
                    document.getElementById('mode-heat-btn').classList.remove('active');
                } else {
                    tempDisplay.classList.remove('cool');
                    tempDisplay.classList.add('heat');
                    document.getElementById('mode-cool-btn').classList.remove('active');
                    document.getElementById('mode-heat-btn').classList.add('active');
                }
                
                // æ›´æ–°é£æ‰‡æ–¹å‘
                document.getElementById('fan-up-btn').classList.remove('active');
                document.getElementById('fan-middle-btn').classList.remove('active');
                document.getElementById('fan-down-btn').classList.remove('active');
                document.getElementById(`fan-${this.fanDirection}-btn`).classList.add('active');
            }
        };

        // ç©ºè°ƒæ§åˆ¶å‡½æ•°
        function toggleAC() {
            const status = AC.togglePower();
            showToast(status ? "ğŸ‘ ç©ºè°ƒå·²å¼€å¯" : "âœŠ ç©ºè°ƒå·²å…³é—­");
        }
        
        function setACMode(mode) {
            AC.setMode(mode);
            showToast(mode === 'cool' ? "ğŸ‘‰ å·²åˆ‡æ¢è‡³å†·é£" : "ğŸ‘‰ å·²åˆ‡æ¢è‡³æš–é£");
        }
        
        function setFanDirection(direction) {
            AC.setFanDirection(direction);
            let msg = "";
            switch(direction) {
                case 'up': msg = "ğŸ“ˆ å·²åˆ‡æ¢è‡³å‘ä¸Šå¹é£"; break;
                case 'down': msg = "ğŸ“‰ å·²åˆ‡æ¢è‡³å‘ä¸‹å¹é£"; break;
                case 'middle': msg = "å·²åˆ‡æ¢è‡³ä¸­é—´å¹é£"; break;
            }
            showToast(msg);
        }

        // --- éŸ³ä¹æ§åˆ¶æ¨¡å— ---
        const Music = {
            player: document.getElementById('music-player'),
            isPlaying: false,
            currentIndex: 0,
            // ä½¿ç”¨å¯å…¬å¼€è®¿é—®çš„MP3é“¾æ¥
            playlist: [
                { 
                    title: "ä¸ƒé‡Œé¦™", 
                    artist: "å‘¨æ°ä¼¦", 
                    src: "https://music.163.com/song/media/outer/url?id=186016.mp3", 
                    cover: "https://picsum.photos/seed/zhoujielun/300/300" 
                },
                { 
                    title: "å­¤å‹‡è€…", 
                    artist: "é™ˆå¥•è¿…", 
                    src: "https://music.163.com/song/media/outer/url?id=1829182182.mp3", 
                    cover: "https://picsum.photos/seed/chenyixun/300/300" 
                },
                { 
                    title: "æ±Ÿå—", 
                    artist: "æ—ä¿Šæ°", 
                    src: "https://music.163.com/song/media/outer/url?id=33787885.mp3", 
                    cover: "https://picsum.photos/seed/linjunjie/300/300" 
                }
            ],
            init() {
                this.loadTrack(0);
                this.player.addEventListener('timeupdate', () => this.updateProgress());
                this.player.addEventListener('ended', () => this.next());
            },
            loadTrack(index) {
                this.currentIndex = index;
                const track = this.playlist[index];
                this.player.src = track.src;
                document.getElementById('player-title').innerText = track.title;
                document.getElementById('dash-song-title').innerText = track.title;
                document.getElementById('player-artist').innerText = track.artist;
                document.getElementById('album-art').src = track.cover;
                this.updatePlayIcon();
            },
            toggle() {
                if (this.isPlaying) this.pause(); else this.play();
            },
            play() {
                this.player.play().catch(e => {
                    console.log("Auto-play blocked, click to play:", e);
                    // è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªæ—¶ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾
                    showToast("ğŸ“¢ æµè§ˆå™¨é™åˆ¶è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®");
                });
                this.isPlaying = true;
                document.getElementById('album-art').classList.add('playing');
                this.updatePlayIcon();
            },
            pause() {
                this.player.pause();
                this.isPlaying = false;
                document.getElementById('album-art').classList.remove('playing');
                this.updatePlayIcon();
            },
            next() {
                this.currentIndex = (this.currentIndex + 1) % this.playlist.length;
                this.loadTrack(this.currentIndex);
                this.play();
            },
            prev() {
                this.currentIndex = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
                this.loadTrack(this.currentIndex);
                this.play();
            },
            setVolume(val) {
                this.player.volume = val;
                document.getElementById('volume-bar').style.width = (val * 100) + '%';
            },
            updatePlayIcon() {
                const icon = document.getElementById('play-icon');
                icon.className = this.isPlaying ? "fas fa-pause" : "fas fa-play ml-1";
            },
            updateProgress() {
                if(this.player.duration) {
                    const pct = (this.player.currentTime / this.player.duration) * 100;
                    document.getElementById('progress-bar').style.width = pct + '%';
                    document.getElementById('curr-time').innerText = this.fmtTime(this.player.currentTime);
                    document.getElementById('total-time').innerText = this.fmtTime(this.player.duration);
                }
            },
            fmtTime(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec < 10 ? '0'+sec : sec}`;
            }
        };

        // --- åœ°å›¾æ¨¡å— (Leaflet) ---
        let leafletMap = null;
        function initLeafletMap() {
            if(leafletMap) return;
            // é»˜è®¤ä½ç½®ï¼šåŒ—äº¬
            leafletMap = L.map('real-map-container', { zoomControl: false }).setView([39.9042, 116.4074], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(leafletMap);

            L.marker([39.9042, 116.4074]).addTo(leafletMap)
                .bindPopup('å½“å‰è½¦è¾†ä½ç½®').openPopup();
        }

        async function searchLocation() {
            const query = document.getElementById('map-search-input').value;
            if(!query) return;
            
            // ä½¿ç”¨ Nominatim å…¬å…± API æœç´¢
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                const data = await res.json();
                if(data && data.length > 0) {
                    const { lat, lon } = data[0];
                    leafletMap.flyTo([lat, lon], 13);
                    L.marker([lat, lon]).addTo(leafletMap).bindPopup(query).openPopup();
                } else {
                    alert("æœªæ‰¾åˆ°åœ°ç‚¹");
                }
            } catch(e) {
                console.error("Search failed", e);
            }
        }

        // --- ç³»ç»Ÿæ ¸å¿ƒ ---
        const State = {
            currentIndex: 0,
            screens: ['dashboard', 'map', 'music', 'ac'],
            lastGestureTime: 0,
            speed: 0,
            gestureActive: false, // æ–°å¢ï¼šæ‰‹åŠ¿è¯†åˆ«çŠ¶æ€
            lastHandPosition: { x: null, y: null }, // ç”¨äºæ‰‹åŠ¿æ–¹å‘åˆ¤æ–­
            gestureHistory: [] // ç”¨äºå­˜å‚¨æœ€è¿‘çš„æ‰‹åŠ¿
        };

        function jumpToScreen(idx) {
            State.currentIndex = idx;
            updateUI();
        }

        function switchScreen(direction) {
            const now = Date.now();
            if (now - State.lastGestureTime < 1000) return;
            State.lastGestureTime = now;

            if (direction === 'next') State.currentIndex = (State.currentIndex + 1) % 4;
            else State.currentIndex = (State.currentIndex - 1 + 4) % 4;
            
            updateUI();
            showToast(direction === 'next' ? "å‘ä¸ŠæŒ¥åŠ¨: ä¸‹ä¸€å±" : "å‘ä¸‹æŒ¥åŠ¨: ä¸Šä¸€å±");
        }

        function updateUI() {
            document.querySelectorAll('.screen').forEach((el, i) => {
                if (i === State.currentIndex) {
                    el.classList.add('active');
                    if(i === 1) setTimeout(initLeafletMap, 500); // å»¶è¿ŸåŠ è½½åœ°å›¾ä»¥ç¡®ä¿å®¹å™¨å¯è§
                } else {
                    el.classList.remove('active');
                }
            });
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${State.currentIndex}`);
            if(activeNav) activeNav.classList.add('active');
        }

        function showToast(msg) {
            const el = document.getElementById('gesture-status');
            el.innerText = msg;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2000);
        }

        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = `${d.getHours()}:${d.getMinutes()<10?'0':''}${d.getMinutes()}`;
            // æ¨¡æ‹Ÿè½¦é€Ÿ
            if(State.speed < 60) State.speed += Math.random();
            else State.speed -= Math.random();
            document.getElementById('speed-display').innerText = Math.floor(State.speed);
        }, 1000);

        // --- æ‰‹åŠ¿ä¸è§†è§‰ ---
        let lastHandY = null;
        let lastHandX = null;
        let gestureDetectionActive = false; // æ–°å¢ï¼šæ£€æµ‹çŠ¶æ€æ ‡å¿—
        const startBtn = document.getElementById('start-btn');
        const videoElement = document.getElementById('input-video');
        const cursor = document.getElementById('hand-cursor');
        const gestureIndicator = document.getElementById('gesture-indicator');
        
        async function initSystem() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                startBtn.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
                
                // åˆå§‹åŒ–3DèƒŒæ™¯
                const container = document.getElementById('canvas-bg');
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.002);
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                const renderer = new THREE.WebGLRenderer({alpha:true});
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);
                
                // æ˜Ÿç©ºèƒŒæ™¯
                const geometry = new THREE.BufferGeometry();
                const vertices = [];
                for(let i=0; i<3000; i++) vertices.push((Math.random()-0.5)*100, (Math.random()-0.5)*60, (Math.random()-0.5)*200);
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                const stars = new THREE.Points(geometry, new THREE.PointsMaterial({color:0x40a9ff, size:0.15}));
                scene.add(stars);
                
                function animate() {
                    requestAnimationFrame(animate);
                    stars.position.z += 0.2;
                    if(stars.position.z > 100) stars.position.z = -100;
                    renderer.render(scene, camera);
                }
                animate();

                // åˆå§‹åŒ–MediaPipe Hands
                const hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                
                // é…ç½®Handsæ¨¡å‹
                hands.setOptions({
                    maxNumHands: 1,
                    minDetectionConfidence: 0.7, // æé«˜æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
                    minTrackingConfidence: 0.7,  // æé«˜è·Ÿè¸ªç½®ä¿¡åº¦é˜ˆå€¼
                    modelComplexity: 1 // ä½¿ç”¨æ›´å¤æ‚çš„æ¨¡å‹æé«˜ç²¾åº¦
                });
                
                // å¤„ç†æ‰‹åŠ¿è¯†åˆ«ç»“æœ
                hands.onResults(onResults);
                
                // å¯åŠ¨æ‘„åƒå¤´
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 640, height: 480, facingMode: "user" } 
                    });
                    
                    videoElement.srcObject = stream;
                    
                    // æ‘„åƒå¤´åŠ è½½å®Œæˆåå¼€å§‹å¤„ç†å¸§
                    videoElement.onloadedmetadata = () => {
                        const cam = new Camera(videoElement, {
                            onFrame: async () => {
                                if (gestureDetectionActive) {
                                    await hands.send({image: videoElement});
                                }
                            },
                            width: 640, 
                            height: 480
                        });
                        cam.start();
                        
                        // æ˜¾ç¤ºé¢„è§ˆæµ
                        const preview = document.getElementById('gesture-preview-video');
                        if(preview) { 
                            preview.srcObject = videoElement.srcObject; 
                            preview.play(); 
                        }
                        
                        // æ˜¾ç¤ºæ‰‹åŠ¿è¯†åˆ«çŠ¶æ€
                        gestureDetectionActive = true;
                        State.gestureActive = true;
                        gestureIndicator.classList.remove('hidden');
                        
                        // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
                        Music.init();
                        
                        // ç§»é™¤åŠ è½½å±‚
                        setTimeout(() => {
                            document.getElementById('loader').remove();
                        }, 1000);
                    };
                } catch (cameraError) {
                    console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', cameraError);
                    document.getElementById('error-msg').textContent = 
                        'æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚è¯·ç¡®ä¿å·²æˆäºˆæ‘„åƒå¤´æƒé™ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´ã€‚';
                    document.getElementById('error-msg').classList.remove('hidden');
                    startBtn.innerText = "é‡è¯•";
                    startBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('error-msg').textContent = 
                    'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message;
                document.getElementById('error-msg').classList.remove('hidden');
                startBtn.innerText = "é‡è¯•";
                startBtn.disabled = false;
            }
        }

        // è®¡ç®—ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»
        function distanceBetweenPoints(a, b) {
            return Math.hypot(a.x - b.x, a.y - b.y);
        }

        // æ£€æµ‹å¼ å¼€çš„æ‰‹æŒ‡æ•°é‡
        function countExtendedFingers(landmarks) {
            // æŒ‡å°–ç´¢å¼•ï¼š4(æ‹‡æŒ‡), 8(é£ŸæŒ‡), 12(ä¸­æŒ‡), 16(æ— åæŒ‡), 20(å°æŒ‡)
            // æŒ‡å…³èŠ‚ç´¢å¼•ï¼š3(æ‹‡æŒ‡), 6(é£ŸæŒ‡), 10(ä¸­æŒ‡), 14(æ— åæŒ‡), 18(å°æŒ‡)
            let count = 0;
            
            // æ£€æµ‹é£ŸæŒ‡
            if (landmarks[8].y < landmarks[6].y) count++;
            
            // æ£€æµ‹ä¸­æŒ‡
            if (landmarks[12].y < landmarks[10].y) count++;
            
            // æ£€æµ‹æ— åæŒ‡
            if (landmarks[16].y < landmarks[14].y) count++;
            
            // æ£€æµ‹å°æŒ‡
            if (landmarks[20].y < landmarks[18].y) count++;
            
            // ç‰¹æ®Šå¤„ç†æ‹‡æŒ‡ï¼ˆä¸å…¶ä»–æ‰‹æŒ‡æ–¹å‘ä¸åŒï¼‰
            if (landmarks[4].x > landmarks[3].x) count++;
            
            return count;
        }

        function onResults(results) {
            // æ›´æ–°æ‰‹åŠ¿æŒ‡ç¤ºå™¨çŠ¶æ€
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                gestureIndicator.textContent = "æ­£åœ¨è¯†åˆ«æ‰‹åŠ¿...";
                gestureIndicator.style.background = "rgba(0, 243, 255, 0.2)";
            } else {
                gestureIndicator.textContent = "æœªæ£€æµ‹åˆ°æ‰‹éƒ¨";
                gestureIndicator.style.background = "rgba(255, 100, 100, 0.2)";
            }

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                cursor.classList.remove('hidden');
                
                // å…‰æ ‡ä½ç½® - è°ƒæ•´åæ ‡æ˜ å°„ï¼Œä½¿å…‰æ ‡æ›´å‡†ç¡®
                const indexTip = lm[8];
                // è°ƒæ•´åæ ‡è®¡ç®—ï¼Œè€ƒè™‘è§†é¢‘é¢„è§ˆçš„é•œåƒæ•ˆæœ
                cursor.style.left = (1 - indexTip.x) * window.innerWidth + 'px';
                cursor.style.top = indexTip.y * window.innerHeight + 'px';

                // æ‰‹åŠ¿é€»è¾‘
                const thumbTip = lm[4];
                const indexPip = lm[6]; // é£ŸæŒ‡ç¬¬äºŒå…³èŠ‚
                const pinkyTip = lm[20];
                const pinkyPip = lm[18]; // å°æŒ‡ç¬¬äºŒå…³èŠ‚
                const wrist = lm[0];
                
                // è®¡ç®—å¼ å¼€çš„æ‰‹æŒ‡æ•°é‡
                const extendedFingers = countExtendedFingers(lm);

                // 1. æ¡æ‹³æ£€æµ‹ (æ”¹è¿›ï¼šæ£€æŸ¥å¤šä¸ªæ‰‹æŒ‡çš„ä½ç½®)
                const isFist = 
                    indexTip.y > indexPip.y && 
                    pinkyTip.y > pinkyPip.y &&
                    lm[12].y > lm[10].y && // ä¸­æŒ‡
                    lm[16].y > lm[14].y;   // æ— åæŒ‡
                
                // 2. æåˆæ£€æµ‹ (è°ƒæ•´é˜ˆå€¼)
                const pinchDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                const isPinching = pinchDist < 0.06; // ç¨å¾®æ”¾å®½é˜ˆå€¼

                // 3. è®°å½•æ‰‹éƒ¨ä½ç½®ç”¨äºæ–¹å‘æ£€æµ‹
                if (State.lastHandPosition.x === null) {
                    State.lastHandPosition.x = wrist.x;
                    State.lastHandPosition.y = wrist.y;
                }
                
                // è®¡ç®—ç§»åŠ¨æ–¹å‘
                const dx = wrist.x - State.lastHandPosition.x; // æ°´å¹³å˜åŒ– (å³ä¸ºæ­£)
                const dy = wrist.y - State.lastHandPosition.y; // å‚ç›´å˜åŒ– (ä¸‹ä¸ºæ­£)
                
                // æ›´æ–°æœ€åä½ç½®
                State.lastHandPosition.x = wrist.x;
                State.lastHandPosition.y = wrist.y;

                // å¤„ç†æ¡æ‹³æ‰‹åŠ¿
                if (isFist) {
                    cursor.classList.add('fist');
                    
                    // ç©ºè°ƒæ§åˆ¶ - æ¡æ‹³å…³é—­ç©ºè°ƒ
                    if (State.currentIndex === 3 && AC.isOn && Date.now() - State.lastGestureTime > 1000) {
                        AC.togglePower();
                        showToast("âœŠ ç©ºè°ƒå·²å…³é—­");
                        State.lastGestureTime = Date.now();
                    }
                    
                    // éŸ³ä¹æ§åˆ¶ - æ¡æ‹³æš‚åœ
                    if (State.currentIndex === 2 && Music.isPlaying && Date.now() - State.lastGestureTime > 1000) {
                        Music.pause();
                        showToast("âœŠ æš‚åœæ’­æ”¾");
                        State.lastGestureTime = Date.now();
                    }
                } else {
                    cursor.classList.remove('fist');
                    
                    // æ£€æµ‹äº”æŒ‡å¼ å¼€
                    const isOpenHand = extendedFingers === 5;
                    
                    // ç©ºè°ƒæ§åˆ¶ - äº”æŒ‡å¼ å¼€æ‰“å¼€ç©ºè°ƒ
                    if (State.currentIndex === 3 && !AC.isOn && isOpenHand && Date.now() - State.lastGestureTime > 1000) {
                        AC.togglePower();
                        showToast("ğŸ‘ ç©ºè°ƒå·²å¼€å¯");
                        State.lastGestureTime = Date.now();
                    }
                    
                    // éŸ³ä¹æ§åˆ¶ - å¼ å¼€æ‰‹æ’­æ”¾
                    if (State.currentIndex === 2 && !Music.isPlaying && !isPinching && isOpenHand && Date.now() - State.lastGestureTime > 1000) {
                        Music.play();
                        showToast("ğŸ–ï¸ å¼€å§‹æ’­æ”¾");
                        State.lastGestureTime = Date.now();
                    }
                }

                // å¤„ç†æåˆæ‰‹åŠ¿
                if (isPinching) {
                    cursor.classList.add('pinching');
                    // æåˆæ§åˆ¶éŸ³é‡/åœ°å›¾
                    const val = Math.min(1, Math.max(0, (pinchDist - 0.02) * 5));
                    if(State.currentIndex === 2) Music.setVolume(val);
                    if(State.currentIndex === 1 && leafletMap) leafletMap.setZoom(3 + val * 10);
                } else {
                    cursor.classList.remove('pinching');
                }

                // 4. æŒ¥æ‰‹æ£€æµ‹ (è°ƒæ•´é˜ˆå€¼ä½¿æ£€æµ‹æ›´çµæ•)
                const currY = wrist.y;
                const currX = wrist.x;

                if (lastHandY !== null && lastHandX !== null) {
                    const deltaY = currY - lastHandY;
                    const deltaX = currX - lastHandX;

                    // å‚ç›´æŒ¥åŠ¨ -> åˆ‡æ¢ç•Œé¢æˆ–ç©ºè°ƒé£å‘
                    if (Math.abs(deltaY) > 0.06 && Math.abs(deltaY) > Math.abs(deltaX)) {
                        // å¦‚æœåœ¨ç©ºè°ƒç•Œé¢ï¼Œä¸Šä¸‹æŒ¥åŠ¨æ§åˆ¶é£å‘
                        if (State.currentIndex === 3 && AC.isOn) {
                            if (deltaY < 0) { // ä¸ŠæŒ¥
                                AC.setFanDirection('up');
                                showToast("ğŸ“ˆ ç©ºè°ƒå¾€ä¸Šå¹é£");
                            } else { // ä¸‹æŒ¥
                                AC.setFanDirection('down');
                                showToast("ğŸ“‰ ç©ºè°ƒå¾€ä¸‹å¹é£");
                            }
                            State.lastGestureTime = Date.now();
                        } else {
                            // å…¶ä»–ç•Œé¢ï¼Œä¸Šä¸‹æŒ¥åŠ¨åˆ‡æ¢å±å¹•
                            if (deltaY < 0) switchScreen('next'); 
                            else switchScreen('prev');
                        }
                        lastHandY = null; lastHandX = null; 
                        return;
                    }

                    // æ°´å¹³æŒ¥åŠ¨ -> éŸ³ä¹åˆ‡æ­Œæˆ–ç©ºè°ƒæ¨¡å¼åˆ‡æ¢
                    if (Math.abs(deltaX) > 0.06 && Math.abs(deltaX) > Math.abs(deltaY)) {
                        // ç©ºè°ƒç•Œé¢ - å³åˆ’åˆ‡æ¢æ¨¡å¼
                        if (State.currentIndex === 3 && AC.isOn && deltaX < 0) { // å³åˆ’ (å› ä¸ºåæ ‡æ˜¯é•œåƒçš„ï¼ŒdeltaX < 0 å®é™…æ˜¯å‘å³)
                            // æ ¹æ®æ‰‹æŒ‡æ•°é‡åˆ¤æ–­æ˜¯åˆ‡æ¢å†·é£è¿˜æ˜¯æš–é£
                            if (extendedFingers === 2) { // ä¸¤æŒ‡å³åˆ’ - åˆ‡æ¢å†·é£
                                AC.setMode('cool');
                                showToast("ğŸ‘‰ ä¸¤æŒ‡å³åˆ’: åˆ‡æ¢å†·é£");
                            } else if (extendedFingers === 3) { // ä¸‰æŒ‡å³åˆ’ - åˆ‡æ¢æš–é£
                                AC.setMode('heat');
                                showToast("ğŸ‘‰ ä¸‰æŒ‡å³åˆ’: åˆ‡æ¢æš–é£");
                            }
                            State.lastGestureTime = Date.now();
                        }
                        // éŸ³ä¹ç•Œé¢ - å·¦å³æŒ¥åŠ¨åˆ‡æ­Œ
                        else if (State.currentIndex === 2) {
                            if (Date.now() - State.lastGestureTime > 1000) {
                                if (deltaX < 0) { Music.next(); showToast("ä¸‹ä¸€é¦–"); } 
                                else { Music.prev(); showToast("ä¸Šä¸€é¦–"); }
                                State.lastGestureTime = Date.now();
                            }
                        }
                        lastHandY = null; lastHandX = null; 
                        return;
                    }
                }
                lastHandY = currY;
                lastHandX = currX;

            } else {
                cursor.classList.add('hidden');
                lastHandY = null;
                lastHandX = null;
                State.lastHandPosition = { x: null, y: null };
            }
        }

        // ä¸ºå¼€å§‹æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ”¯æŒé‡è¯•
        startBtn.addEventListener('click', async () => {
            startBtn.innerText = "å¯åŠ¨ä¸­...";
            startBtn.disabled = true;
            document.getElementById('error-msg').classList.add('hidden');
            await initSystem();
        });

        window.toggleFullScreen = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>